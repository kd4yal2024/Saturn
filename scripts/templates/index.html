<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saturn Update Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 1rem;
            overflow-y: auto;
            min-height: 400px;
            max-height: 500px;
            line-height: 1.4;
            margin: 0;
            border: 1px solid #444;
            box-sizing: border-box;
        }
        .output-container {
            width: 100%;
            min-height: 420px;
            background-color: #1a1a1a;
            padding: 0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f3f4f6; }
        .container { max-width: 800px; }
        .ansi_31 { color: #ff5555 !important; }
        .ansi_32 { color: #55ff55 !important; }
        .ansi_33 { color: #ffff55 !important; }
        .ansi_34 { color: #5555ff !important; }
        .ansi_36 { color: #55ffff !important; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-red-600 text-center mb-2">Saturn Update Manager</h1>
        <p class="text-lg text-gray-600 text-center mb-4">Build Version: 2.65 (Setup Script)</p>
        
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Script Versions</h2>
            <ul id="version-list" class="list-disc pl-5 text-gray-600"></ul>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <form id="script-form" class="flex flex-col space-y-4">
                <div class="flex items-center space-x-4">
                    <label for="script" class="text-lg font-medium text-gray-700">Select Script:</label>
                    <select id="script" name="script" class="border rounded px-2 py-1 bg-blue-100 text-blue-800">
                        <option value="">Select a script</option>
                    </select>
                </div>
                <div id="flags" class="flex flex-wrap gap-4"></div>
                <div class="flex justify-center space-x-4">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Run</button>
                    <button type="button" id="change-password-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Change Password</button>
                    <button type="button" id="exit-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Exit</button>
                </div>
            </form>
        </div>

        <div class="output-container">
            <pre id="output" class="text-sm"></pre>
        </div>

        <!-- Backup Prompt Modal -->
        <div id="backup-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                <h2 class="text-xl font-bold mb-4">Backup Prompt</h2>
                <p class="mb-4">Create a backup? (Y/n)</p>
                <div class="flex justify-end space-x-4">
                    <button id="backup-yes" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Yes</button>
                    <button id="backup-no" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">No</button>
                </div>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                <h2 class="text-xl font-bold mb-4">Change Password</h2>
                <form id="password-form" class="flex flex-col space-y-4">
                    <div>
                        <label for="new-password" class="text-lg font-medium text-gray-700">New Password:</label>
                        <input type="password" id="new-password" name="new-password" class="border rounded px-2 py-1 w-full" required minlength="8">
                    </div>
                    <div>
                        <label for="confirm-password" class="text-lg font-medium text-gray-700">Confirm Password:</label>
                        <input type="password" id="confirm-password" name="confirm-password" class="border rounded px-2 py-1 w-full" required minlength="8">
                    </div>
                    <p id="password-error" class="text-red-500 hidden">Passwords do not match or are too short.</p>
                    <div class="flex justify-end space-x-4">
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Submit</button>
                        <button type="button" id="password-cancel" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        async function loadVersions() {
            console.log('Attempting to load script versions from /saturn/get_versions');
            try {
                const response = await fetch('/saturn/get_versions', {
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Fetch versions failed:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                const data = await response.json();
                console.log('Versions response:', data);
                const versionList = document.getElementById('version-list');
                versionList.innerHTML = '';
                if (data.versions) {
                    Object.entries(data.versions).forEach(([script, version]) => {
                        const li = document.createElement('li');
                        li.textContent = `${script}: ${version}`;
                        versionList.appendChild(li);
                    });
                } else {
                    console.warn('No versions returned from /saturn/get_versions');
                    document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error: No versions available</span>\n`;
                }
            } catch (error) {
                console.error('Error loading versions:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error loading versions: ${error.message}</span>\n`;
            }
        }

        async function loadFlags(script) {
            console.log('Attempting to load flags for:', script);
            try {
                const response = await fetch(`/saturn/get_flags?script=${encodeURIComponent(script)}`, {
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Fetch flags failed:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                const data = await response.json();
                console.log('Flags response:', data);
                const flagsDiv = document.getElementById('flags');
                flagsDiv.innerHTML = '';
                if (data.error) {
                    console.error('Error from get_flags:', data.error);
                    document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error: ${data.error}</span>\n`;
                    return;
                }
                data.flags.forEach(flag => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2';
                    label.innerHTML = `<input type="checkbox" name="flags" value="${flag}" class="form-checkbox h-5 w-5 text-blue-600" ${flag === '--verbose' ? 'checked' : ''}> <span>${flag}</span>`;
                    flagsDiv.appendChild(label);
                });
                console.log(`Loaded flags for ${script}:`, data.flags);
            } catch (error) {
                console.error('Error loading flags:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error loading flags: ${error.message}</span>\n`;
            }
        }

        async function loadScripts() {
            console.log('Attempting to load scripts from /saturn/get_scripts');
            try {
                const response = await fetch('/saturn/get_scripts', {
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Fetch scripts failed:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                const data = await response.json();
                console.log('Scripts response:', data);
                const scriptSelect = document.getElementById('script');
                scriptSelect.innerHTML = '<option value="">Select a script</option>';
                if (data.scripts) {
                    data.scripts.forEach(script => {
                        const option = document.createElement('option');
                        option.value = script;
                        option.textContent = script;
                        scriptSelect.appendChild(option);
                    });
                    if (data.scripts.length > 0) {
                        console.log('Loading flags for first script:', data.scripts[0]);
                        loadFlags(data.scripts[0]);
                    }
                } else {
                    console.warn('No scripts returned from /saturn/get_scripts');
                    document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error: No scripts available</span>\n`;
                }
            } catch (error) {
                console.error('Error loading scripts:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error loading scripts: ${error.message}</span>\n`;
            }
        }

        document.getElementById('script-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const script = document.getElementById('script').value;
            const flags = Array.from(document.querySelectorAll('input[name="flags"]:checked')).map(cb => cb.value);
            const output = document.getElementById('output');
            output.innerHTML = '';
            console.log(`Submitting run request for ${script}, flags:`, flags);

            try {
                const formData = new FormData();
                formData.append('script', script);
                flags.forEach(flag => formData.append('flags', flag));
                const response = await fetch('/saturn/run', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'text/event-stream'
                    }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Run request failed:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                console.log('Run request sent successfully');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        console.log('Stream complete');
                        if (buffer) {
                            console.log('Processing buffered data:', buffer);
                            const lines = buffer.split('\n\n');
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const data = line.substring(6);
                                    console.log(`Received data: ${data}`);
                                    if (data === 'BACKUP_PROMPT') {
                                        console.log('Received BACKUP_PROMPT');
                                        document.getElementById('backup-modal').classList.remove('hidden');
                                    } else {
                                        output.innerHTML += data + '\n';
                                        console.log(`Appended HTML: ${data}`);
                                        output.scrollTop = output.scrollHeight;
                                        output.style.height = output.scrollHeight + 'px';
                                    }
                                }
                            }
                            buffer = '';
                        }
                        break;
                    }
                    const chunk = decoder.decode(value, { stream: true });
                    console.log('Received chunk:', chunk);
                    buffer += chunk;
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop() || '';
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            console.log(`Received data: ${data}`);
                            if (data === 'BACKUP_PROMPT') {
                                console.log('Received BACKUP_PROMPT');
                                document.getElementById('backup-modal').classList.remove('hidden');
                            } else {
                                output.innerHTML += data + '\n';
                                console.log(`Appended HTML: ${data}`);
                                output.scrollTop = output.scrollHeight;
                                output.style.height = output.scrollHeight + 'px';
                            }
                        }
                    }
                }
            } catch(error) {
                console.error('Run error:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error: ${error.message}</span>\n`;
            }
        });

        document.getElementById('script').addEventListener('change', function() {
            console.log('Script changed:', this.value);
            if (this.value) {
                loadFlags(this.value);
            }
        });

        document.getElementById('backup-yes').addEventListener('click', function() {
            console.log('Sending backup response: y');
            fetch('/saturn/backup_response', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'response=y'
            }).then(() => {
                console.log('Backup response sent: y');
                document.getElementById('backup-modal').classList.add('hidden');
            }).catch(error => {
                console.error('Backup yes error:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error sending backup response: ${error.message}</span>\n`;
            });
        });

        document.getElementById('backup-no').addEventListener('click', function() {
            console.log('Sending backup response: n');
            fetch('/saturn/backup_response', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'response=n'
            }).then(() => {
                console.log('Backup response sent: n');
                document.getElementById('backup-modal').classList.add('hidden');
            }).catch(error => {
                console.error('Backup no error:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error sending backup response: ${error.message}</span>\n`;
            });
        });

        document.getElementById('change-password-btn').addEventListener('click', function() {
            console.log('Opening password change modal');
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('password-error').classList.add('hidden');
        });

        document.getElementById('password-cancel').addEventListener('click', function() {
            console.log('Closing password change modal');
            document.getElementById('password-modal').classList.add('hidden');
        });

        document.getElementById('password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('password-error');
            if (newPassword !== confirmPassword || newPassword.length < 8) {
                console.error('Password validation failed');
                errorDiv.textContent = 'Passwords do not match or are too short (minimum 8 characters).';
                errorDiv.classList.remove('hidden');
                return;
            }
            try {
                const response = await fetch('/saturn/change_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `new_password=${encodeURIComponent(newPassword)}`
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    console.log('Password changed successfully');
                    document.getElementById('output').innerHTML += `<span style="color:#00FF00">Password changed successfully</span>\n`;
                    document.getElementById('password-modal').classList.add('hidden');
                } else {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error changing password:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error changing password: ${error.message}</span>\n`;
            }
        });

        document.getElementById('exit-btn').addEventListener('click', async function() {
            console.log('Initiating exit and logoff');
            try {
                const response = await fetch('/saturn/exit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Exit request failed:', response.status, errorText);
                    document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error during exit: ${errorText}</span>\n`;
                    return;
                }
                const data = await response.json();
                console.log('Exit response:', data);
                if (data.status === 'shutting down') {
                    console.log('Server shutting down, forcing re-authentication');
                    // Force re-authentication by fetching a protected endpoint with invalid credentials
                    try {
                        await fetch('/saturn/', {
                            headers: {
                                'Authorization': 'Basic invalid_credentials',
                                'Cache-Control': 'no-cache'
                            }
                        });
                    } catch (error) {
                        console.log('Re-authentication triggered:', error);
                        // Redirect to /saturn/ to prompt login
                        window.location.href = '/saturn/';
                    }
                }
            } catch (error) {
                console.error('Exit error:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error during exit: ${error.message}</span>\n`;
            }
        });

        console.log('Loading initial scripts and versions');
        loadScripts();
        loadVersions();
    </script>
</body>
</html>
