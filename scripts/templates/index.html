<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saturn Update Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: inherit; /* Rely on ansi2html inline styles */
            padding: 1rem;
            overflow-y: auto;
            min-height: 400px;
            max-height: 400px;
            line-height: 1.2;
            margin: 0;
            border: 1px solid #333;
            box-sizing: border-box;
        }
        .output-container {
            width: 100%;
            min-height: 420px;
            background-color: #000;
            padding: 0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f3f4f6; }
        .container { max-width: 800px; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-red-600 text-center mb-6">Saturn Update Manager</h1>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <form id="script-form" class="flex flex-col space-y-4">
                <div class="flex items-center space-x-4">
                    <label for="script" class="text-lg font-medium text-gray-700">Select Script:</label>
                    <select id="script" name="script" class="border rounded px-2 py-1 bg-blue-100 text-blue-800">
                        {% for script in scripts %}
                            <option value="{{ script }}">{{ script }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="flags" class="flex flex-wrap gap-4"></div>
                <div class="flex justify-center space-x-4">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Run</button>
                    <button type="button" id="exit-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Exit</button>
                </div>
            </form>
        </div>

        <div class="output-container">
            <pre id="output" class="text-sm"></pre>
        </div>

        <!-- Backup Prompt Modal -->
        <div id="backup-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                <h2 class="text-xl font-bold mb-4">Backup Prompt</h2>
                <p class="mb-4">Create a backup? (Y/n)</p>
                <div class="flex justify-end space-x-4">
                    <button id="backup-yes" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Yes</button>
                    <button id="backup-no" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">No</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadFlags(script) {
            try {
                const response = await fetch(`/get_flags?script=${encodeURIComponent(script)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                const data = await response.json();
                const flagsDiv = document.getElementById('flags');
                flagsDiv.innerHTML = '';
                if (data.error) {
                    document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error: ${data.error}</span>\n`;
                    return;
                }
                data.flags.forEach(flag => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2';
                    label.innerHTML = `<input type="checkbox" name="flags" value="${flag}" class="form-checkbox h-5 w-5 text-blue-600"> <span>${flag}</span>`;
                    flagsDiv.appendChild(label);
                });
                console.log(`Loaded flags for ${script}:`, data.flags);
            } catch (error) {
                console.error('Error loading flags:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error loading flags: ${error.message}</span>\n`;
            }
        }

        document.getElementById('script-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const script = document.getElementById('script').value;
            const flags = Array.from(document.querySelectorAll('input[name="flags"]:checked')).map(cb => cb.value);
            const output = document.getElementById('output');
            output.innerHTML = '';
            console.log(`Submitting run request for script: ${script}, flags:`, flags);

            try {
                const formData = new FormData();
                formData.append('script', script);
                flags.forEach(flag => formData.append('flags', flag));
                const response = await fetch('/run', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                console.log('Run request sent successfully');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        console.log('Stream complete');
                        break;
                    }
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            console.log(`Received data: ${data}`);
                            if (data === 'BACKUP_PROMPT') {
                                console.log('Received BACKUP_PROMPT');
                                document.getElementById('backup-modal').classList.remove('hidden');
                            } else {
                                output.innerHTML += data + '\n';
                                console.log(`Appended HTML: ${data}`);
                                output.scrollTop = output.scrollHeight;
                                output.style.height = output.scrollHeight + 'px';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Run error:', error);
                output.innerHTML += `<span style="color:#FF0000">Error: ${error.message}</span>\n`;
            }
        });

        document.getElementById('script').addEventListener('change', function() {
            console.log('Script changed:', this.value);
            loadFlags(this.value);
        });

        document.getElementById('backup-yes').addEventListener('click', function() {
            console.log('Sending backup response: y');
            fetch('/backup_response', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'response=y'
            }).then(() => {
                console.log('Backup response sent: y');
                document.getElementById('backup-modal').classList.add('hidden');
            }).catch(error => {
                console.error('Backup yes error:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error sending backup response: ${error.message}</span>\n`;
            });
        });

        document.getElementById('backup-no').addEventListener('click', function() {
            console.log('Sending backup response: n');
            fetch('/backup_response', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'response=n'
            }).then(() => {
                console.log('Backup response sent: n');
                document.getElementById('backup-modal').classList.add('hidden');
            }).catch(error => {
                console.error('Backup no error:', error);
                document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error sending backup response: ${error.message}</span>\n`;
            });
        });

        document.getElementById('exit-btn').addEventListener('click', function() {
            console.log('Sending exit request');
            fetch('/exit', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Exit request successful, closing window');
                        window.close();
                    } else {
                        throw new Error('Exit failed');
                    }
                })
                .catch(error => {
                    console.error('Exit error:', error);
                    document.getElementById('output').innerHTML += `<span style="color:#FF0000">Error exiting: ${error.message}</span>\n`;
                });
        });

        console.log('Loading initial flags');
        loadFlags(document.getElementById('script').value);
    </script>
</body>
</html>
